class Solution {
public:
    long long maxPower(vector<int>& stations, int r, int k) {
        int n = stations.size();
        vector<long long> pref(n);
        pref[0] = stations[0];
        for (int i = 1; i < n; ++i) pref[i] = pref[i-1] + stations[i];
        auto rangeSum = [&](int l, int rr)->long long{
            if (l > rr) return 0;
            return pref[rr] - (l>0 ? pref[l-1] : 0);
        };
        vector<long long> power(n);
        for (int i = 0; i < n; ++i) {
            int L = max(0, i - r);
            int R = min(n-1, i + r);
            power[i] = rangeSum(L, R);
        }
        long long lo = 0, hi = pref.back() + k, ans = 0;
        while (lo <= hi) {
            long long mid = (lo + hi) >> 1;
            vector<long long> diff(n);
            long long used = 0, curAdd = 0;
            bool ok = true;
            for (int i = 0; i < n; ++i) {
                if (i - r - 1 >= 0) curAdd -= diff[i - r - 1];
                long long total = power[i] + curAdd;
                if (total < mid) {
                    long long need = mid - total;
                    used += need;
                    if (used > k) { ok = false; break; }
                    curAdd += need;
                    int pos = min(n-1, i + r);
                    diff[pos] += need;
                }
            }
            if (ok) { ans = mid; lo = mid + 1; }
            else hi = mid - 1;
        }
        return ans;
    }
};
